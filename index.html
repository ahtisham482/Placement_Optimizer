<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Amazon PPC Bid Adjustment Optimizer</title>
  <style>
    /* ---------- Base Layout & Theme ---------- */
    :root {
      --bg-gradient: radial-gradient(circle at top left, #eef2ff 0, #f9fafb 35%, #fdf2ff 80%);
      --card-bg: rgba(255, 255, 255, 0.96);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --accent: #6366f1;
      --accent-soft: #e0e7ff;
      --accent-strong: #4f46e5;
      --danger-soft: #fef2f2;
      --danger: #b91c1c;
      --success-soft: #ecfdf5;
      --success: #059669;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
      --radius-lg: 18px;
      --radius-pill: 999px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: var(--bg-gradient);
      margin: 0;
      padding: 32px 16px 40px;
      color: var(--text-main);
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* ---------- Header ---------- */
    .app-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }

    .title-block h1 {
      font-size: 28px;
      letter-spacing: -0.03em;
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title-pill {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.06);
      color: #4b5563;
      text-transform: uppercase;
      letter-spacing: .12em;
    }

    .subtitle {
      margin: 0;
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .steps-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .step-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px;
      color: #4b5563;
    }

    .step-badge {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent);
      color: white;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    /* ---------- Cards ---------- */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 18px 18px 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-subtle);
      margin-bottom: 18px;
      backdrop-filter: blur(14px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-dot {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-title-dot span {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* ---------- File input & helper text ---------- */
    .file-input-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    input[type="file"] {
      padding: 7px 10px;
      font-size: 13px;
      border-radius: 9px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      background: rgba(249, 250, 251, 0.9);
      cursor: pointer;
      transition: border-color var(--transition-fast), background var(--transition-fast), box-shadow var(--transition-fast);
    }

    input[type="file"]:hover {
      border-color: var(--accent);
      background: white;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.25);
    }

    .hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .loading {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .loading-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.5);
      border-top-color: var(--accent);
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: var(--danger-soft);
      color: var(--danger);
      font-size: 12px;
      border: 1px solid rgba(248, 113, 113, 0.5);
    }

    .stats {
      margin-top: 10px;
      font-size: 13px;
      color: #111827;
    }

    .stats strong {
      color: var(--accent-strong);
    }

    .sheet-used {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .product-summary {
      margin-top: 12px;
      font-size: 12px;
      color: #111827;
    }

    .product-summary span {
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 4px;
      padding: 3px 9px;
      border-radius: var(--radius-pill);
      background: #eef2ff;
      color: #4338ca;
      font-size: 11px;
    }

    /* ---------- CVR Inputs ---------- */
    .cvr-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      padding: 4px 0;
    }

    .cvr-label {
      min-width: 220px;
      font-size: 13px;
      color: #111827;
      font-weight: 500;
    }

    .cvr-input {
      width: 110px;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
      background: rgba(249, 250, 251, 0.95);
    }

    .cvr-input:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.25);
      background: white;
    }

    /* ---------- Buttons ---------- */
    .btn-primary {
      margin-top: 10px;
      padding: 8px 18px;
      border-radius: var(--radius-pill);
      border: none;
      cursor: pointer;
      background: radial-gradient(circle at top left, #4f46e5 0, #1f2937 100%);
      color: #f9fafb;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: .01em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.45);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast), filter var(--transition-fast);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
      filter: brightness(1.05);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .btn-primary small {
      font-size: 11px;
      opacity: 0.8;
    }

    .cvr-status {
      margin-top: 8px;
      font-size: 12px;
    }

    /* ---------- Table & Filters ---------- */
    .table-controls {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .table-controls label {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .table-controls input[type="checkbox"] {
      accent-color: var(--accent-strong);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 8px;
      font-size: 12px;
    }

    th, td {
      border: 1px solid rgba(226, 232, 240, 0.9);
      padding: 7px 9px;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: linear-gradient(to bottom, #f9fafb, #edf2ff);
      font-weight: 600;
      white-space: nowrap;
      font-size: 11px;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: .06em;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      box-shadow: 0 1px 0 rgba(148, 163, 184, 0.7);
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    tr.updated-row td {
      background: var(--success-soft);
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .footer-note strong {
      color: #111827;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: var(--radius-pill);
      padding: 2px 9px;
      font-size: 11px;
      background: #eef2ff;
      color: #4338ca;
      margin-left: 6px;
      border: 1px solid rgba(129, 140, 248, 0.35);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .card {
        padding: 16px 14px 18px;
      }
      .title-block h1 {
        font-size: 22px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Header -->
    <header class="app-header">
      <div class="title-block">
        <h1>
          Amazon PPC Bid Adjustment Optimizer
          <span class="title-pill">Sponsored Products • Placements</span>
        </h1>
        <p class="subtitle">
          Upload your bulksheet, set target conversion rates per product, and instantly calculate
          placement bid adjustments—export-ready for Amazon.
        </p>

        <div class="steps-row">
          <div class="step-chip">
            <span class="step-badge">1</span>
            Filter enabled <strong>&nbsp;Bidding adjustments</strong>
          </div>
          <div class="step-chip">
            <span class="step-badge">2</span>
            Enter product-level <strong>&nbsp;conversion rates</strong>
          </div>
          <div class="step-chip">
            <span class="step-badge">3</span>
            Auto-adjust placements &amp; <strong>&nbsp;download bulksheet</strong>
          </div>
        </div>
      </div>
    </header>

    <!-- FILE UPLOAD CARD -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <div class="card-title-dot"><span></span></div>
          Step 1 · Upload bulksheet
        </div>
      </div>

      <div class="card-subtitle">
        Works with Sponsored Products bulk sheets (XLSX/XLS or CSV/TSV/TXT).  
        The tool will auto-select the <strong>“Sponsored Products Campaigns”</strong> sheet.
      </div>

      <div class="file-input-wrapper">
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv,.tsv,.txt">
        <div class="hint">
          Drag & drop or click to choose file. We only read in your browser—nothing is uploaded to a server.
        </div>
      </div>

      <div id="loading" class="loading" style="display:none;">
        <span class="loading-dot"></span> Processing file…
      </div>
      <div id="error" class="error" style="display:none;"></div>
      <div id="stats" class="stats" style="display:none;"></div>
      <div id="sheetUsed" class="sheet-used" style="display:none;"></div>
      <div id="summary" class="product-summary" style="display:none;"></div>
    </div>

    <!-- CVR INPUT CARD -->
    <div class="card" id="cvrCard" style="display:none;">
      <div class="card-header">
        <div class="card-title">
          <div class="card-title-dot"><span></span></div>
          Step 2 · Target conversion rates
        </div>
      </div>
      <div class="card-subtitle">
        Set a target conversion rate per product. Adjustments are applied per placement row:
        rows below target get <strong>-10 pts</strong>, rows above target get <strong>+5 pts</strong>,
        0% CR rows are handled using the clicks / required-clicks logic.
      </div>

      <div id="cvrContainer"></div>

      <button id="saveCvrBtn" class="btn-primary">
        Apply rules
        <small>(update placement percentages)</small>
      </button>
      <div id="cvrStatus" class="cvr-status" style="display:none;"></div>
    </div>

    <!-- TABLE CARD -->
    <div class="card" id="tableCard" style="display:none;">
      <div class="card-header">
        <div class="card-title">
          <div class="card-title-dot"><span></span></div>
          Step 3 · Review bidding-adjustment rows
        </div>
      </div>

      <div style="font-size:14px; font-weight:600; margin-bottom:4px;">
        Bidding Adjustment Rows (Enabled campaigns only)
        <span class="badge" id="rowCountBadge"></span>
      </div>

      <div class="table-controls">
        <span id="updatedSummary"></span>
        <label>
          <input type="checkbox" id="showUpdatedOnly">
          Show only updated rows
        </label>
      </div>

      <div style="font-size:12px; color:#6b7280; margin-bottom:10px;">
        Product name is taken from the campaign name before the first <code>|</code>.  
        Rows highlighted in green have updated <strong>Percentage</strong> and will be uploaded with <strong>Operation = "Update"</strong>.
      </div>

      <div style="max-height: 500px; overflow:auto; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.35);">
        <table id="resultTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Product Name</th>
              <th>Campaign Name</th>
              <th>Campaign State</th>
              <th>Placement</th>
              <th>Clicks</th>
              <th>Row Conversion Rate</th>
              <th>Old %</th>
              <th>New %</th>
              <th>Campaign ID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <button id="downloadBtn" class="btn-primary" style="display:none;">
        Download updated bulk file
      </button>
      <div class="footer-note">
        Downloaded file keeps <strong>only</strong> the header row and the rows where
        <strong>Operation = "Update"</strong>. This makes the file much smaller for Amazon upload.<br>
        Only <strong>Percentage</strong> and <strong>Operation</strong>
        are changed on bidding-adjustment rows for enabled campaigns.  
        A dedupe pass runs when reading the sheet and again before download, so the exported sheet has
        <strong>no duplicate rows</strong>.
      </div>
    </div>
  </div>

  <!-- JS: logic updated to keep only Operation="Update" rows on export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  const fileInput = document.getElementById("fileInput");
  const loadingEl = document.getElementById("loading");
  const errorEl   = document.getElementById("error");
  const statsEl   = document.getElementById("stats");
  const summaryEl = document.getElementById("summary");
  const sheetUsedEl = document.getElementById("sheetUsed");
  const tableCard = document.getElementById("tableCard");
  const rowCountBadge = document.getElementById("rowCountBadge");
  const resultTableBody = document.querySelector("#resultTable tbody");

  const cvrCard = document.getElementById("cvrCard");
  const cvrContainer = document.getElementById("cvrContainer");
  const saveCvrBtn = document.getElementById("saveCvrBtn");
  const cvrStatus = document.getElementById("cvrStatus");
  const downloadBtn = document.getElementById("downloadBtn");

  const updatedSummaryEl = document.getElementById("updatedSummary");
  const showUpdatedOnlyEl = document.getElementById("showUpdatedOnly");

  let currentRows = [];
  let productList = [];
  let productCvrMap = {};
  let globalIsExcel = false;
  let globalWorkbook = null;
  let globalSheetName = null;
  let globalDelimiter = null;
  let globalSheetData = null;

  let idxEntity = -1;
  let idxCampaignName = -1;
  let idxCampaignState = -1;
  let idxPlacement = -1;
  let idxPercentage = -1;
  let idxCampaignId = -1;
  let idxConvRate = -1;
  let idxOperation = -1;
  let idxClicks = -1;

  let debugTotalBidding = 0;
  let debugTotalBiddingEnabled = 0;

  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;

    resetUI();
    loadingEl.style.display = "flex";

    const reader = new FileReader();
    const name = file.name.toLowerCase();
    const isExcel = name.endsWith(".xlsx") || name.endsWith(".xls");
    globalIsExcel = isExcel;

    reader.onload = (e) => {
      try {
        if (isExcel) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          globalWorkbook = workbook;

          const desiredName = "Sponsored Products Campaigns";
          let sheetNameToUse = null;

          if (workbook.SheetNames.includes(desiredName)) {
            sheetNameToUse = desiredName;
          } else {
            const lowerNames = workbook.SheetNames.map(n => n.toLowerCase());
            const idx = lowerNames.findIndex(n =>
              n.includes("sponsored products") && n.includes("campaign")
            );
            if (idx !== -1) {
              sheetNameToUse = workbook.SheetNames[idx];
            } else {
              sheetNameToUse = workbook.SheetNames[0];
            }
          }

          globalSheetName = sheetNameToUse;
          const worksheet = workbook.Sheets[sheetNameToUse];

          sheetUsedEl.style.display = "block";
          sheetUsedEl.textContent = 'Using sheet: "' + sheetNameToUse + '"';

          const tsv = XLSX.utils.sheet_to_csv(worksheet, { FS: "\t" });
          handleParsedText(tsv);
        } else {
          globalWorkbook = null;
          globalSheetName = null;
          const text = e.target.result;
          handleParsedText(text);
        }
      } catch (err) {
        loadingEl.style.display = "none";
        showError("Error processing file: " + err.message);
        console.error(err);
      }
    };

    reader.onerror = () => {
      loadingEl.style.display = "none";
      showError("Failed to read file.");
    };

    if (isExcel) {
      reader.readAsArrayBuffer(file);
    } else {
      reader.readAsText(file);
    }
  });

  function handleParsedText(text) {
    const rows = processBulkText(text);

    loadingEl.style.display = "none";

    if (rows.length === 0) {
      if (debugTotalBidding === 0) {
        showError('No rows found where Entity starts with "Bidding". This bulksheet may have been exported without bidding adjustments / placements.');
      } else if (debugTotalBiddingEnabled === 0) {
        showError('Found ' + debugTotalBidding + ' bidding-adjustment row(s) in total, but 0 where Campaign state is "enabled". All bidding rows are for paused/archived campaigns.');
      } else {
        showError('No rows found with Entity = "Bidding adjustment" and Campaign state = "enabled".');
      }
      return;
    }

    currentRows = rows;
    renderStats(rows);
    renderSummary(rows);
    renderTable(rows);
    renderCvrInputs(rows);
  }

  function resetUI() {
    errorEl.style.display = "none";
    errorEl.textContent = "";
    statsEl.style.display = "none";
    statsEl.textContent = "";
    summaryEl.style.display = "none";
    summaryEl.textContent = "";
    sheetUsedEl.style.display = "none";
    sheetUsedEl.textContent = "";
    tableCard.style.display = "none";
    resultTableBody.innerHTML = "";
    cvrCard.style.display = "none";
    cvrContainer.innerHTML = "";
    cvrStatus.style.display = "none";
    cvrStatus.textContent = "";
    downloadBtn.style.display = "none";
    updatedSummaryEl.textContent = "";
    showUpdatedOnlyEl.checked = false;

    currentRows = [];
    productList = [];
    productCvrMap = {};

    globalWorkbook = null;
    globalSheetName = null;
    globalSheetData = null;
    globalDelimiter = null;

    idxEntity = idxCampaignName = idxCampaignState = idxPlacement =
      idxPercentage = idxCampaignId = idxConvRate = idxOperation = idxClicks = -1;

    debugTotalBidding = 0;
    debugTotalBiddingEnabled = 0;
  }

  function showError(msg) {
    errorEl.style.display = "block";
    errorEl.textContent = msg;
  }

  function headerIndex(headers, name) {
    const target = name.toLowerCase();
    return headers.findIndex(h => h.toLowerCase() === target);
  }

  function processBulkText(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (lines.length === 0) throw new Error("File is empty.");

    const firstLine = lines[0];
    const delimiter = firstLine.indexOf("\t") !== -1 ? "\t" : ",";
    globalDelimiter = delimiter;

    const rawSheetData = lines.map(line => line.split(delimiter));

    const seen = new Set();
    const deduped = [];
    for (let i = 0; i < rawSheetData.length; i++) {
      const row = rawSheetData[i];
      if (i === 0) {
        deduped.push(row);
        continue;
      }
      const key = row.map(cell => (cell == null ? "" : String(cell))).join("\u0001");
      if (seen.has(key)) continue;
      seen.add(key);
      deduped.push(row);
    }
    globalSheetData = deduped;

    const headers = globalSheetData[0].map(h => h.trim());

    idxEntity        = headerIndex(headers, "Entity");
    idxCampaignName  = headerIndex(headers, "Campaign name (Informational only)");
    idxCampaignState = headerIndex(headers, "Campaign state (Informational only)");
    idxPlacement     = headerIndex(headers, "Placement");
    idxPercentage    = headerIndex(headers, "Percentage");
    idxCampaignId    = headerIndex(headers, "Campaign ID");
    idxConvRate      = headerIndex(headers, "Conversion rate");
    idxOperation     = headerIndex(headers, "Operation");
    idxClicks        = headerIndex(headers, "Clicks");

    const required = [
      { name: "Entity", idx: idxEntity },
      { name: "Campaign name (Informational only)", idx: idxCampaignName },
      { name: "Campaign state (Informational only)", idx: idxCampaignState },
      { name: "Placement", idx: idxPlacement },
      { name: "Percentage", idx: idxPercentage },
      { name: "Campaign ID", idx: idxCampaignId },
      { name: "Conversion rate", idx: idxConvRate },
      { name: "Operation", idx: idxOperation },
      { name: "Clicks", idx: idxClicks }
    ];

    const missing = required.filter(c => c.idx === -1).map(c => c.name);
    if (missing.length > 0) {
      throw new Error("Missing required column(s): " + missing.join(", "));
    }

    const result = [];
    debugTotalBidding = 0;
    debugTotalBiddingEnabled = 0;

    for (let i = 1; i < globalSheetData.length; i++) {
      const cols = globalSheetData[i];
      if (!cols || cols.length === 0 || cols.join("").trim() === "") continue;

      const entityRaw = (cols[idxEntity] || "").trim();
      const entityNorm = entityRaw.toLowerCase();
      if (!entityNorm.startsWith("bidding")) continue;

      debugTotalBidding++;

      const campaignStateRaw = (cols[idxCampaignState] || "").trim();
      const campaignStateNorm = campaignStateRaw.toLowerCase();

      if (campaignStateNorm !== "enabled") {
        continue;
      }
      debugTotalBiddingEnabled++;

      const campaignName = (cols[idxCampaignName] || "").trim();
      const placement    = (cols[idxPlacement] || "").trim();
      const percentageStr = (cols[idxPercentage] || "").trim();
      const campaignId   = (cols[idxCampaignId] || "").trim();
      const convStrRaw   = (cols[idxConvRate] || "").trim();
      const clicksStrRaw = (cols[idxClicks] || "").trim();

      let productName = campaignName;
      if (campaignName.includes("|")) {
        productName = campaignName.split("|")[0].trim();
      } else {
        productName = campaignName.trim();
      }

      let oldPct = parseFloat(percentageStr);
      if (Number.isNaN(oldPct)) oldPct = 0;

      let convStr = convStrRaw.replace("%", "").trim();
      let convVal = parseFloat(convStr);
      if (Number.isNaN(convVal)) convVal = NaN;

      let clicksVal = parseFloat(clicksStrRaw.replace(/,/g, ""));
      if (Number.isNaN(clicksVal)) clicksVal = NaN;

      result.push({
        rowIndex: i,
        productName,
        campaignName,
        campaignState: campaignStateRaw,
        placement,
        convRate: convVal,
        convRateStr: convStrRaw,
        clicks: clicksVal,
        clicksStr: clicksStrRaw,
        oldPercentage: oldPct,
        percentage: String(oldPct),
        campaignId,
        updated: false
      });
    }

    console.log("Enabled bidding adjustment rows found (deduped):", result.length);
    console.log("Debug counts: bidding rows total =", debugTotalBidding,
                ", enabled =", debugTotalBiddingEnabled);
    return result;
  }

  function renderStats(rows) {
    const uniqueCampaigns = new Set(rows.map(r => r.campaignId || r.campaignName));
    statsEl.style.display = "block";
    statsEl.innerHTML = `
      <strong>${rows.length}</strong> bidding adjustment row(s) for ENABLED campaigns across
      <strong>${uniqueCampaigns.size}</strong> campaign(s).
    `;
  }

  function renderSummary(rows) {
    const counts = {};
    rows.forEach(r => {
      if (!r.productName) return;
      counts[r.productName] = (counts[r.productName] || 0) + 1;
    });

    const productNames = Object.keys(counts);
    if (productNames.length === 0) return;

    summaryEl.style.display = "block";
    summaryEl.innerHTML = `
      <strong>Product summary (rows per product):</strong><br>
      ${productNames.map(p => `<span>${escapeHtml(p)}: ${counts[p]}</span>`).join(" ")}
    `;
  }

  function renderTable(rows) {
    tableCard.style.display = "block";
    rowCountBadge.textContent = rows.length + " rows";

    const updatedCount = rows.filter(r => r.updated).length;
    updatedSummaryEl.textContent = `${updatedCount} row(s) updated out of ${rows.length} bidding adjustment row(s).`;

    resultTableBody.innerHTML = "";
    rows.forEach((r, index) => {
      const tr = document.createElement("tr");
      if (r.updated) tr.classList.add("updated-row");
      tr.dataset.rowIndex = index;

      const convDisplay = Number.isNaN(r.convRate)
        ? escapeHtml(r.convRateStr || "")
        : (r.convRate.toFixed(2) + "%");

      const clicksDisplay = Number.isNaN(r.clicks)
        ? escapeHtml(r.clicksStr || "")
        : r.clicks.toString();

      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${escapeHtml(r.productName)}</td>
        <td>${escapeHtml(r.campaignName)}</td>
        <td>${escapeHtml(r.campaignState)}</td>
        <td>${escapeHtml(r.placement)}</td>
        <td>${clicksDisplay}</td>
        <td>${convDisplay}</td>
        <td>${r.oldPercentage}</td>
        <td>${escapeHtml(r.percentage)}</td>
        <td>${escapeHtml(r.campaignId)}</td>
      `;
      resultTableBody.appendChild(tr);
    });

    updateRowVisibility();
  }

  function renderCvrInputs(rows) {
    const productsSet = new Set();
    rows.forEach(r => {
      if (r.productName) productsSet.add(r.productName);
    });

    productList = Array.from(productsSet).sort((a, b) =>
      a.localeCompare(b, undefined, { sensitivity: "base" })
    );

    if (productList.length === 0) {
      cvrCard.style.display = "none";
      return;
    }

    cvrCard.style.display = "block";
    cvrContainer.innerHTML = "";

    productList.forEach(product => {
      const rowDiv = document.createElement("div");
      rowDiv.className = "cvr-row";

      const label = document.createElement("div");
      label.className = "cvr-label";
      label.textContent = product;

      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.max = "100";
      input.step = "0.01";
      input.placeholder = "e.g. 10";
      input.className = "cvr-input";
      input.dataset.productName = product;

      const suffix = document.createElement("span");
      suffix.style.fontSize = "13px";
      suffix.style.color = "#6b7280";
      suffix.textContent = "%";

      rowDiv.appendChild(label);
      rowDiv.appendChild(input);
      rowDiv.appendChild(suffix);

      cvrContainer.appendChild(rowDiv);
    });

    productCvrMap = {};
    cvrStatus.style.display = "none";
    cvrStatus.textContent = "";
  }

  saveCvrBtn.addEventListener("click", () => {
    if (productList.length === 0) return;

    const inputs = cvrContainer.querySelectorAll("input.cvr-input");
    const map = {};
    let missing = [];

    inputs.forEach(input => {
      const productName = input.dataset.productName;
      const valueStr = (input.value || "").trim();
      if (!valueStr) {
        missing.push(productName);
        return;
      }
      const num = Number(valueStr);
      if (Number.isNaN(num) || num <= 0) {
        missing.push(productName + " (invalid or <= 0)");
        return;
      }
      map[productName] = num;
    });

    if (missing.length > 0) {
      cvrStatus.style.display = "block";
      cvrStatus.style.color = "#b91c1c";
      cvrStatus.textContent = "Please enter a valid conversion rate (> 0) for: " + missing.join(", ");
      return;
    }

    productCvrMap = map;
    console.log("Saved product CVRs:", productCvrMap);

    applyAdjustmentRules();
    renderTable(currentRows);

    cvrStatus.style.display = "block";
    cvrStatus.style.color = "#059669";
    cvrStatus.textContent = "Conversion rates applied. Percentages updated where rules were triggered.";

    downloadBtn.style.display = "inline-flex";
  });

  showUpdatedOnlyEl.addEventListener("change", updateRowVisibility);

  function updateRowVisibility() {
    const onlyUpdated = showUpdatedOnlyEl.checked;
    const trs = resultTableBody.querySelectorAll("tr");

    trs.forEach(tr => {
      const idx = parseInt(tr.dataset.rowIndex, 10);
      const data = currentRows[idx];
      tr.style.display = (!onlyUpdated || (data && data.updated)) ? "" : "none";
    });
  }

  function applyAdjustmentRules() {
    if (!currentRows || currentRows.length === 0) return;
    if (!productCvrMap || Object.keys(productCvrMap).length === 0) return;
    if (!globalSheetData) return;

    currentRows.forEach(row => {
      const target = productCvrMap[row.productName];
      if (target === undefined || target <= 0) return;

      const rowCR = row.convRate;
      const clicks = row.clicks;

      let oldPct = row.oldPercentage;
      let newPct = oldPct;

      if (typeof rowCR === "number" && !Number.isNaN(rowCR)) {
        if (rowCR === 0) {
          const requiredClicks = 100 / target;
          if (Number.isFinite(requiredClicks) &&
              typeof clicks === "number" &&
              !Number.isNaN(clicks) &&
              clicks > requiredClicks) {
            newPct = oldPct - 10;
            if (newPct < 0) newPct = 0;
          } else {
            newPct = oldPct;
          }
        } else if (rowCR < target) {
          newPct = oldPct - 10;
          if (newPct < 0) newPct = 0;
        } else if (rowCR > target) {
          if (oldPct < 100) {
            newPct = oldPct + 5;
            if (newPct > 100) newPct = 100;
          } else {
            newPct = oldPct;
          }
        } else {
          newPct = oldPct;
        }
      }

      if (newPct !== oldPct) {
        row.percentage = String(newPct);
        row.updated = true;

        if (row.rowIndex != null && row.rowIndex < globalSheetData.length) {
          globalSheetData[row.rowIndex][idxPercentage] = String(newPct);
          if (idxOperation !== -1) {
            globalSheetData[row.rowIndex][idxOperation] = "Update";
          }
        }
      } else {
        row.updated = false;
      }
    });
  }

  function dedupeSheetData() {
    if (!globalSheetData) return;
    const seen = new Set();
    const deduped = [];

    for (let i = 0; i < globalSheetData.length; i++) {
      const row = globalSheetData[i];
      const key = row.map(cell => (cell == null ? "" : String(cell))).join("\u0001");
      if (seen.has(key)) continue;
      seen.add(key);
      deduped.push(row);
    }

    globalSheetData = deduped;
  }

  // NEW: Keep only header row + rows where Operation = "Update"
  function keepOnlyUpdateOperationRows() {
    if (!globalSheetData || idxOperation === -1) return;
    if (globalSheetData.length === 0) return;

    const filtered = [];
    // Always keep header row
    filtered.push(globalSheetData[0]);

    for (let i = 1; i < globalSheetData.length; i++) {
      const row = globalSheetData[i];
      const opVal = (row[idxOperation] || "").trim().toLowerCase();
      if (opVal === "update") {
        filtered.push(row);
      }
    }

    globalSheetData = filtered;
  }

  downloadBtn.addEventListener("click", () => {
    if (!globalSheetData) {
      alert("No updated sheet data to download.");
      return;
    }

    // First, keep only rows with Operation = "Update" to make file small
    keepOnlyUpdateOperationRows();

    // Then dedupe the remaining rows
    dedupeSheetData();

    if (globalIsExcel && globalWorkbook && globalSheetName) {
      const ws = XLSX.utils.aoa_to_sheet(globalSheetData);
      globalWorkbook.Sheets[globalSheetName] = ws;

      const wbout = XLSX.write(globalWorkbook, { bookType: "xlsx", type: "array" });
      const blob = new Blob([wbout], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "bulk-updated.xlsx";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } else {
      const lines = globalSheetData.map(row =>
        row.map(cell => (cell == null ? "" : String(cell))).join(globalDelimiter || "\t")
      );
      const text = lines.join("\r\n");
      const ext = (globalDelimiter === "," ? "csv" : "tsv");
      const blob = new Blob([text], { type: "text/plain;charset=utf-8;" });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "bulk-updated." + ext;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  });

  function escapeHtml(str) {
    if (typeof str !== "string") return "";
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
</body>
</html>
